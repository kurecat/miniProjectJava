<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <title>My Page</title>
  </head>
  <body>
    <div class="container">
      <div th:replace="~{fragments/header :: header}"></div>

      <div class="profile-container">
        <div class="profile-info">
          <div class="profile-info__avatar-wrapper">
            <img
              id="user-avatar"
              src="https://via.placeholder.com/280x280.png?text=Profile"
              alt="User Avatar"
              class="profile-info__avatar"
            />
          </div>
          <p id="display-username" class="profile-info__username">username</p>
          <p id="display-points" class="profile-info__points">P : 1530</p>

          <button id="edit-profile-button" class="profile-info__edit-button">
            Edit Profile
          </button>

          <div id="auth-section" class="auth-section hidden">
            <div class="auth-section__password-input-group">
              <label for="enter-password" class="auth-section__label"
                >Enter Password</label
              >
              <input
                type="password"
                id="enter-password"
                class="auth-section__input"
                placeholder="Enter Password"
              />
            </div>
          </div>

          <div id="edit-fields-section" class="edit-fields-section hidden">
            <div class="edit-fields-section__group">
              <label for="edit-username" class="edit-fields-section__label"
                >Edit username</label
              >
              <input
                type="text"
                id="edit-username"
                class="edit-fields-section__input"
              />
            </div>
            <div class="edit-fields-section__group">
              <label for="edit-password" class="edit-fields-section__label"
                >Edit password</label
              >
              <input
                type="password"
                id="edit-password"
                class="edit-fields-section__input"
              />
            </div>
            <div class="edit-fields-section__group">
              <label for="edit-profile-image" class="edit-fields-section__label"
                >Edit Profile Image</label
              >
              <label
                for="upload-profile-image"
                class="edit-fields-section__upload-label"
                >Upload Profile Image</label
              >
              <input
                type="file"
                id="upload-profile-image"
                class="edit-fields-section__upload-input"
                accept="image/*"
              />
            </div>

            <div class="edit-fields-section__buttons">
              <button
                id="save-button"
                class="edit-fields-section__button edit-fields-section__button--save"
              >
                Save
              </button>
              <button
                id="cancel-button"
                class="edit-fields-section__button edit-fields-section__button--cancel"
              >
                Cancel
              </button>
              <button
                id="delete-button"
                class="edit-fields-section__button edit-fields-section__button--delete"
              >
                Delete
              </button>
            </div>
          </div>
        </div>

        <div class="content-lists">
          <div class="content-list__section">
            <h3 class="content-list__title">My Post list</h3>
            <div class="content-list__placeholder">게시물이 없습니다.</div>
          </div>
          <div class="content-list__section">
            <h3 class="content-list__title">My Comment list</h3>
            <div class="content-list__placeholder">댓글이 없습니다.</div>
          </div>
        </div>
      </div>

      <div th:replace="~{fragments/footer :: footer}"></div>
    </div>

    <script>
      // ⭐️⭐️⭐️ 동적 기능 JavaScript ⭐️⭐️⭐️

      // 이 줄(DOMContentLoaded)이 빠지면 오류가 발생할 수 있습니다.
      document.addEventListener("DOMContentLoaded", function () {
        // --- 1. 초기 UI 상태 및 데이터 설정 ---
        const user = {
          username: "test",
          points: 1530,
          password: "test", // 비밀번호 시뮬레이션
          avatarUrl: "https://via.placeholder.com/280x280.png?text=Profile", // ⭐️ 이미지 URL도 올바른지 확인
        };

        // DOM 요소들 가져오기
        const editProfileButton = document.getElementById(
          "edit-profile-button"
        );
        const authSection = document.getElementById("auth-section");
        const enterPasswordInput = document.getElementById("enter-password");
        const editFieldsSection = document.getElementById(
          "edit-fields-section"
        );
        const editUsernameInput = document.getElementById("edit-username");
        const editPasswordInput = document.getElementById("edit-password");
        const uploadProfileImageInput = document.getElementById(
          "upload-profile-image"
        );
        const saveButton = document.getElementById("save-button");
        const cancelButton = document.getElementById("cancel-button");
        const deleteButton = document.getElementById("delete-button");
        const userAvatar = document.getElementById("user-avatar");
        const displayUsername = document.getElementById("display-username");
        const displayPoints = document.getElementById("display-points");

        // 초기 사용자 정보 표시
        displayUsername.textContent = user.username;
        displayPoints.textContent = `P : ${user.points}`;
        userAvatar.src = user.avatarUrl;
        editUsernameInput.value = user.username;

        // --- 2. 이벤트 리스너 설정 ---

        // A. "Edit Profile" 버튼 클릭 시
        editProfileButton.addEventListener("click", function () {
          authSection.classList.remove("hidden"); // Enter Password 필드 보이기
          enterPasswordInput.focus(); // Enter Password 필드에 포커스
          if (!editFieldsSection.classList.contains("hidden")) {
            // 이미 열려있으면 아무것도 안함
          } else {
            enterPasswordInput.value = ""; // 항상 초기화
            editFieldsSection.classList.add("hidden"); // 수정 필드는 다시 숨김
          }
        });

        // B. "Enter Password" 입력 후 포커스 아웃 시 (또는 Enter 키)
        enterPasswordInput.addEventListener("blur", checkPassword);
        enterPasswordInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            checkPassword();
          }
        });

        function checkPassword() {
          const enteredPassword = enterPasswordInput.value;
          // ⭐️⭐️⭐️ 비밀번호 일치 시뮬레이션 ⭐️⭐️⭐️
          if (enteredPassword === user.password) {
            editFieldsSection.classList.remove("hidden"); // 수정 필드 섹션 보이기
            // 현재 값으로 수정 필드 초기화
            editUsernameInput.value = user.username;
            editPasswordInput.value = ""; // 비밀번호는 보안상 초기화
            authSection.classList.add("hidden"); // Enter Password 필드 숨기기
          } else if (enteredPassword !== "") {
            alert("비밀번호가 일치하지 않습니다.");
            enterPasswordInput.value = ""; // 틀리면 입력값 지우기
            editFieldsSection.classList.add("hidden"); // 수정 필드 다시 숨김
          } else {
            // 입력값이 비어있을 경우 (지웠을 경우)
            editFieldsSection.classList.add("hidden"); // 수정 필드 다시 숨김
            authSection.classList.add("hidden"); // Enter Password 필드 숨기기
          }
        }

        // C. "Save" 버튼 클릭 시
        saveButton.addEventListener("click", function () {
          let changed = false;

          // 1. 사용자 이름 변경
          if (editUsernameInput.value !== user.username) {
            user.username = editUsernameInput.value;
            displayUsername.textContent = user.username;
            changed = true;
          }

          // 2. 비밀번호 변경 (입력된 경우에만)
          if (editPasswordInput.value !== "") {
            user.password = editPasswordInput.value;
            alert("비밀번호가 변경되었습니다.");
            changed = true;
          }

          // 3. 프로필 이미지 변경 (새로운 파일이 선택된 경우에만)
          if (uploadProfileImageInput.files.length > 0) {
            const newImageFile = uploadProfileImageInput.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
              user.avatarUrl = e.target.result;
              userAvatar.src = user.avatarUrl;
              changed = true;
            };
            reader.readAsDataURL(newImageFile);
          }

          if (changed) {
            alert("프로필이 성공적으로 업데이트되었습니다!");
          } else {
            alert("변경된 내용이 없습니다.");
          }

          editFieldsSection.classList.add("hidden");
          authSection.classList.add("hidden");
          enterPasswordInput.value = "";
        });

        // D. "Cancel" 버튼 클릭 시
        cancelButton.addEventListener("click", function () {
          editFieldsSection.classList.add("hidden");
          authSection.classList.add("hidden");
          enterPasswordInput.value = "";
          editUsernameInput.value = user.username;
          editPasswordInput.value = "";
          uploadProfileImageInput.value = "";
        });

        // E. "Delete" 버튼 클릭 시 (시뮬레이션)
        deleteButton.addEventListener("click", function () {
          if (
            confirm(
              "정말로 계정을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다."
            )
          ) {
            alert("계정이 삭제되었습니다. (시뮬레이S이뮬레이션)");
            window.location.href = "/login";
          }
        });

        // ⭐️⭐️⭐️ 이 '}'(닫는 중괄호)가 document.addEventListener의 짝입니다.
        // ⭐️⭐️⭐️ 이 부분이 누락되거나, 이 뒤에 }가 더 있으면 오류가 발생합니다.
      });
    </script>
  </body>
</html>
